<html>
<head>
<meta charset='utf-8'>
<title>SGS</title>
<script src='/static/jquery-latest.js'></script>
<script src='/static/event_parse.js'></script>
<script src='/static/hint_parse.js'></script>
<script src='/static/strings.js'></script>
<script src='/static/graphics.js'></script>
<script src='/static/data.js'></script>
<script src='/static/views.js'></script>
<script>
var getInfo = function() {};
var eventlist = new SGS_EventParser();
var game = null;
var token = localStorage.getItem('token');

var actionSocket = null;
var statusSocket = null;

function send(socket, data, url, onResult) {
    data['token'] = token;
    data['controller'] = url;
    socket.onmessage = function(event) {
        onResult(eval('(' + event.data + ')'));
    };
    socket.send(JSON.stringify(data));
}

function queryStatus(data, url, onResult) {
    send(statusSocket, data, url, onResult);
}

function sendAction(data, url, onResult) {
    send(actionSocket, data, url, onResult);
}

function playerAct(data) {
    return sendAction(data, 'act', function(result) {
        if (result['code'] != 200) {
            console.error('SEND: ' + JSON.stringify(data));
            console.error('REASON: ' + result['reason']);
        }
    });
}

function joinGame() {
    sendAction({}, 'add', function(result) {
        if (result['code'] == 200) {
            token = result['token'];
            localStorage.setItem('token', token);
            enter();
        } else {
            msgPane.innerHTML = result['reason'];
        }
    });
}

function updateRoomPlayers(count, is_host) {
    document.getElementById('players_count').innerHTML = count;
    document.getElementById('start_button').disabled = (0 == is_host);
}

function enter() {
    joinPane.style.visibility = 'hidden';
    startPane.style.visibility = 'visible';
    getInfo = function() {
        queryStatus({}, 'status', function(result) {
            if (result['started'] == 0) {
                updateRoomPlayers(result['players'], result['host']);
            } else {
                started();
            }
        });
    };
    getInfo();
}

function exitGame() {
    joinPane.style.visibility = 'visible';
    startPane.style.visibility = 'hidden';
    sendAction({}, 'exit', function(r) {});
    token = null;
}

function startGame() {
    sendAction({}, 'start', function(result) {
        if (result['code'] == 200) {
            started();
        } else {
            msgPane.innerHTML = result['reason'];
        }
    });
}

function started() {
    function getEventsHints() {
        queryStatus({ 'previous event id': eventlist.prevId() }, 'events',
                    function(result) {
                        eventlist.append(result, game);
                        queryStatus({}, 'hint', function(result) {
                            game.hint(result);
                        });
                    });
    }

    function firstGetEvents() {
        queryStatus({ 'previous event id': eventlist.prevId() }, 'events',
                    function(result) {
                        eventlist.append(result, game);
                        game.enableAnimation();
                        getInfo = getEventsHints;
                        getInfo();
                    });
    }
    startPane.style.visibility = 'hidden';
    gamePane.style.visibility = 'visible';
    firstGetEvents();
}

var joinPane = null;
var startPane = null;
var gamePane = null;
var msgPane = null;

function init() {
    paras = document.getElementsByTagName('p');
    joinPane = paras[0];
    startPane = paras[1];
    gamePane = paras[2];
    msgPane = paras[3];
    startPane.style.visibility = 'hidden';
    gamePane.style.visibility = 'hidden';

    game = new Game(gamePane);

    var protocol = 'ws://';
    actionSocket = new WebSocket(protocol + window.location.host + '/action');
    statusSocket = new WebSocket(protocol + window.location.host + '/status');
    statusSocket.onopen = function() {
        queryStatus({}, 'checktoken', function(result) {
            if (result['in'] == 1) {
                enter();
            }
        });
    };

    var cmdSocket = new WebSocket('ws://localhost:8000/cmd');
    cmdSocket.onmessage = function(event) {
        var message = eval('(' + event.data + ')');
        ({
            'update': function() {
                getInfo();
            },
        })[message['action']]();
    };
}
</script>
</head>
<body onload='init()'>
<p><button onclick='joinGame()'>Join</button></p>
<p>
<button id='start_button' onclick='startGame()'>Start</button>
<button onclick='exitGame()'>Exit</button>
<span id='players_count'></span> player(s) in the room now.
</p>
<p></p>
<p></p>
